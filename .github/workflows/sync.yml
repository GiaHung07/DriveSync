name: Google Drive Auto Sync

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:
  repository_dispatch:
    types: [sync-trigger]

concurrency:
  group: sync-gdrive
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install rclone
        run: |
          curl -s https://rclone.org/install.sh | sudo bash
          rclone version | head -1

      - name: Setup rclone config
        run: |
          mkdir -p ~/.config/rclone
          echo '${{ secrets.RCLONE_CONFIG }}' > ~/.config/rclone/rclone.conf

      - name: Sync folders
        id: sync
        continue-on-error: true
        env:
          SYNC_PAIRS: ${{ secrets.SYNC_FOLDERS }}
        run: |
          echo "Starting sync..."
          
          # Simple tree builder (no mapfile, direct output)
          build_tree() {
            local log_file="$1"
            local src="$2"
            local dst="$3"
            local output_file="$4"
            
            echo "ğŸ“¦ $src â†’ $dst:" >> "$output_file"
            
            # Extract files to temp file first
            grep ": Copied" "$log_file" 2>/dev/null | sed -E 's/.*INFO *: *(.+): Copied.*/\1/' | head -15 | sort > /tmp/extracted_files.txt
            
            local total_lines=$(wc -l < /tmp/extracted_files.txt)
            local current=0
            
            while IFS= read -r filepath; do
              ((current++))
              
              # Tree prefix
              if [ "$current" -eq "$total_lines" ]; then
                prefix="â””â”€â”€"
              else
                prefix="â”œâ”€â”€"
              fi
              
              # Get icon
              ext="${filepath##*.}"
              case "${ext,,}" in
                pdf) icon="ğŸ“•" ;;
                doc|docx) icon="ğŸ“˜" ;;
                xls|xlsx) icon="ğŸ“—" ;;
                ppt|pptx) icon="ğŸ“™" ;;
                jpg|jpeg|png|gif|bmp|webp) icon="ğŸ–¼ï¸" ;;
                mp4|avi|mkv|mov|webm) icon="ğŸ¬" ;;
                mp3|wav|flac|ogg) icon="ğŸµ" ;;
                zip|rar|7z|tar|gz) icon="ğŸ“¦" ;;
                exe|msi|app|bat) icon="âš™ï¸" ;;
                txt|md) icon="ğŸ“" ;;
                c|cpp|py|js|java|html|css) icon="ğŸ’»" ;;
                *) icon="ğŸ“„" ;;
              esac
              
              # Output with folder indicator if has path
              if [[ "$filepath" == *"/"* ]]; then
                echo "$prefix ğŸ“‚ $icon $filepath" >> "$output_file"
              else
                echo "$prefix $icon $filepath" >> "$output_file"
              fi
            done < /tmp/extracted_files.txt
          }
          
          TOTAL=0
          FILELIST="/tmp/files.txt"
          > "$FILELIST"
          
          PAIR1=$(echo "$SYNC_PAIRS" | cut -d',' -f1)
          PAIR2=$(echo "$SYNC_PAIRS" | cut -d',' -f2)
          
          # Sync pair 1
          if [ -n "$PAIR1" ]; then
            SRC1=$(echo "$PAIR1" | cut -d':' -f1)
            DST1=$(echo "$PAIR1" | cut -d':' -f2)
            echo "Pair 1: $SRC1 -> $DST1"
            
            # Use --stats-one-line for better parsing
            rclone copy "gdrive:${SRC1}" "gdrive:${DST1}" --exclude "*.tmp" --exclude "Thumbs.db" -v --stats-one-line 2>&1 | tee /tmp/log1.txt || true
            
            echo "=== DEBUG: rclone output ==="
            cat /tmp/log1.txt
            
            # Try multiple patterns to detect copied files
            C1=0
            # Pattern 1: ": Copied"
            C1a=$(grep -c ": Copied" /tmp/log1.txt 2>/dev/null || echo "0")
            # Pattern 2: "Transferred:" from stats
            C1b=$(grep -oP 'Transferred:\s+\K[0-9]+' /tmp/log1.txt 2>/dev/null | head -1 || echo "0")
            # Pattern 3: "(new)" for new files
            C1c=$(grep -c "(new)" /tmp/log1.txt 2>/dev/null || echo "0")
            
            echo "DEBUG: Copied=$C1a, Transferred=$C1b, New=$C1c"
            
            # Take max of detected counts
            C1=$(echo -e "$C1a\n${C1b:-0}\n$C1c" | sort -rn | head -1)
            C1=${C1:-0}
            echo "Pair 1 final count: $C1"
            
            if [ "$C1" -gt 0 ]; then
              build_tree "/tmp/log1.txt" "$SRC1" "$DST1" "$FILELIST"
            fi
            TOTAL=$((TOTAL + C1))
          fi
          
          # Sync pair 2
          if [ -n "$PAIR2" ] && [ "$PAIR2" != "$PAIR1" ]; then
            SRC2=$(echo "$PAIR2" | cut -d':' -f1)
            DST2=$(echo "$PAIR2" | cut -d':' -f2)
            echo "Pair 2: $SRC2 -> $DST2"
            
            rclone copy "gdrive:${SRC2}" "gdrive:${DST2}" --exclude "*.tmp" --exclude "Thumbs.db" -v --stats-one-line 2>&1 | tee /tmp/log2.txt || true
            
            C2=0
            C2a=$(grep -c ": Copied" /tmp/log2.txt 2>/dev/null || echo "0")
            C2b=$(grep -oP 'Transferred:\s+\K[0-9]+' /tmp/log2.txt 2>/dev/null | head -1 || echo "0")
            C2c=$(grep -c "(new)" /tmp/log2.txt 2>/dev/null || echo "0")
            C2=$(echo -e "$C2a\n${C2b:-0}\n$C2c" | sort -rn | head -1)
            C2=${C2:-0}
            echo "Pair 2 final count: $C2"
            
            if [ "$C2" -gt 0 ]; then
              echo "" >> "$FILELIST"
              build_tree "/tmp/log2.txt" "$SRC2" "$DST2" "$FILELIST"
            fi
            TOTAL=$((TOTAL + C2))
          fi
          
          echo "=== TOTAL: $TOTAL files ==="
          echo "files=$TOTAL" >> $GITHUB_OUTPUT
          cat "$FILELIST" || true
          cp "$FILELIST" /tmp/notify.txt || true

      - name: Update state.json
        if: always()
        run: |
          FILES="${{ steps.sync.outputs.files }}"
          FILES=${FILES:-0}
          NOW=$(TZ='Asia/Ho_Chi_Minh' date '+%Y-%m-%d %H:%M:%S')
          DETAILS=""
          if [ -f /tmp/notify.txt ]; then
            DETAILS=$(cat /tmp/notify.txt | tr '\n' '|' | head -c 500)
          fi
          echo "Updating state: $FILES files"
          if [ ! -f state.json ]; then
            echo '{"stats":{"totalSyncs":0,"totalFiles":0,"lastSync":""},"history":[]}' > state.json
          fi
          jq --arg now "$NOW" --argjson files "$FILES" --arg details "$DETAILS" '.stats.totalSyncs += 1 | .stats.totalFiles += $files | .stats.lastSync = $now | .history = ([{"time": $now, "files": $files, "details": $details}] + .history)[:50]' state.json > tmp.json && mv tmp.json state.json
          cat state.json

      - name: Commit state
        if: always()
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add state.json
          git diff --staged --quiet || git commit -m "Sync $(TZ='Asia/Ho_Chi_Minh' date '+%H:%M')"
          git push || true

      - name: Telegram notification
        if: always()
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          FILES="${{ steps.sync.outputs.files }}"
          FILES=${FILES:-0}
          NOW=$(TZ='Asia/Ho_Chi_Minh' date '+%H:%M:%S')
          echo "DEBUG: FILES=$FILES"
          if [ "$FILES" -gt 0 ]; then
            echo "Sending notification..."
            DETAILS=""
            if [ -f /tmp/notify.txt ]; then
              DETAILS=$(cat /tmp/notify.txt)
            fi
            
            # Random greetings
            GREETINGS=("ğŸ”” CÃ³ file má»›i nÃ¨ sáº¿p Æ¡i!" "ğŸ‰ Oni-chan, cÃ³ file má»›i!" "ğŸ“¢ Tháº§y Æ¡i cÃ³ tÃ i liá»‡u má»›i!" "ğŸš€ Äáº¡i ca, hÃ ng vá» rá»“i nÃ¨!" "âœ¨ Boss, file má»›i Ä‘Ã£ sync!" "ğŸ§ Anh Æ¡i cÃ³ file nÃ¨!" "ğŸ’¼ Sáº¿p Æ¡i, cáº­p nháº­t má»›i!" "ğŸ CÃ³ quÃ  cho sáº¿p nÃ¨!")
            RANDOM_IDX=$((RANDOM % 8))
            GREETING="${GREETINGS[$RANDOM_IDX]}"
            
            MSG="$GREETING"$'\n'"ğŸ•’ $NOW"$'\n'"ğŸ“ $FILES file(s)"$'\n\n'"$DETAILS"$'\n'"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"$'\n'"ğŸ’¡ /sync â€¢ /status"
            if [ -n "$BOT_TOKEN" ] && [ -n "$CHAT_ID" ]; then
              RESP=$(curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" -d "chat_id=${CHAT_ID}" -d "text=${MSG}")
              echo "Response: $RESP"
            else
              echo "ERROR: Missing secrets!"
            fi
          else
            echo "FILES=0, skip notification"
          fi
