name: Google Drive Auto Sync

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install rclone
        run: |
          curl -s https://rclone.org/install.sh | sudo bash
          rclone version | head -1

      - name: Setup rclone config
        run: |
          mkdir -p ~/.config/rclone
          echo '${{ secrets.RCLONE_CONFIG }}' > ~/.config/rclone/rclone.conf

      - name: Sync folders
        id: sync
        run: |
          echo "Starting sync..."
          
          SUCCESS=0
          FAIL=0
          
          echo "========================================"
          echo "Syncing: 01 -> 02"
          if rclone copy "gdrive:01" "gdrive:02" --exclude "*.tmp" --exclude "Thumbs.db" -v --stats-one-line 2>&1; then
            SUCCESS=$((SUCCESS + 1))
            echo "Success!"
          else
            FAIL=$((FAIL + 1))
            echo "Failed!"
          fi
          
          echo "========================================"
          echo "Syncing: C++ T10 2025 -> C++"
          if rclone copy "gdrive:C++ T10 2025" "gdrive:C++" --exclude "*.tmp" --exclude "Thumbs.db" -v --stats-one-line 2>&1; then
            SUCCESS=$((SUCCESS + 1))
            echo "Success!"
          else
            FAIL=$((FAIL + 1))
            echo "Failed!"
          fi
          
          echo "========================================"
          echo "Summary: Success=$SUCCESS, Failed=$FAIL"
          
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "fail=$FAIL" >> $GITHUB_OUTPUT

      - name: Send Telegram notification
        if: always()
        env:
          TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "Telegram not configured"
            exit 0
          fi
          
          SUCCESS="${{ steps.sync.outputs.success }}"
          FAIL="${{ steps.sync.outputs.fail }}"
          NOW=$(date '+%Y-%m-%d %H:%M:%S')
          
          if [ "$FAIL" -gt 0 ]; then
            STATUS="Sync co loi"
          else
            STATUS="Sync thanh cong"
          fi
          
          MESSAGE="Drive Sync Report - ${STATUS} - Success: ${SUCCESS}, Failed: ${FAIL} - Time: ${NOW}"
          
          curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
            -d "chat_id=${CHAT_ID}" \
            -d "text=${MESSAGE}" || echo "Telegram send failed"
