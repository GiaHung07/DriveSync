name: Telegram Bot Commands

on:
  repository_dispatch:
    types: [telegram_command]

jobs:
  handle_command:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Process command
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          COMMAND: ${{ github.event.client_payload.command }}
          ARGS: ${{ github.event.client_payload.args }}
        run: |
          send_message() {
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "parse_mode=Markdown" \
              -d "text=$1"
          }
          
          case "$COMMAND" in
            status)
              LAST_SYNC=$(jq -r '.stats.lastSync // "Ch∆∞a c√≥"' state.json)
              TOTAL_SYNCS=$(jq -r '.stats.totalSyncs' state.json)
              SUCCESS=$(jq -r '.stats.success' state.json)
              FAIL=$(jq -r '.stats.fail' state.json)
              
              MSG="üìä *Tr·∫°ng th√°i h·ªá th·ªëng*
              
üïê Last sync: ${LAST_SYNC}
üìà Total syncs: ${TOTAL_SYNCS}
‚úÖ Success: ${SUCCESS}
‚ùå Failed: ${FAIL}
üîÑ Auto-sync: M·ªói 5 ph√∫t"
              
              send_message "$MSG"
              ;;
              
            stats)
              STATS=$(jq '.stats' state.json)
              TOTAL_FILES=$(echo "$STATS" | jq -r '.totalFiles')
              TOTAL_BYTES=$(echo "$STATS" | jq -r '.totalBytes')
              
              MSG="üìà *Th·ªëng k√™ chi ti·∫øt*
              
üìÅ T·ªïng files ƒë√£ sync: ${TOTAL_FILES}
üíæ T·ªïng dung l∆∞·ª£ng: ${TOTAL_BYTES} bytes
‚úÖ Th√†nh c√¥ng: $(echo "$STATS" | jq -r '.success')
‚ùå Th·∫•t b·∫°i: $(echo "$STATS" | jq -r '.fail')
üïê L·∫ßn sync cu·ªëi: $(echo "$STATS" | jq -r '.lastSync // "Ch∆∞a c√≥"')"
              
              send_message "$MSG"
              ;;
              
            history)
              HISTORY=$(jq -r '.history[:10][] | "‚Ä¢ \(.time): \(.files) files (\(if .success then "‚úÖ" else "‚ùå" end))"' state.json 2>/dev/null || echo "Ch∆∞a c√≥ l·ªãch s·ª≠")
              
              MSG="üìú *L·ªãch s·ª≠ 10 l·∫ßn sync g·∫ßn nh·∫•t*

${HISTORY}"
              
              send_message "$MSG"
              ;;
              
            sync)
              send_message "üîÑ ƒêang trigger sync..."
              # Trigger the sync workflow
              curl -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/actions/workflows/sync.yml/dispatches" \
                -d '{"ref":"main","inputs":{"force_message":"true"}}'
              ;;
              
            help|*)
              MSG="ü§ñ *Drive Sync Bot - Commands*
              
/status - Xem tr·∫°ng th√°i hi·ªán t·∫°i
/stats - Xem th·ªëng k√™ chi ti·∫øt
/history - 10 l·∫ßn sync g·∫ßn nh·∫•t
/sync - Trigger sync ngay
/help - Hi·ªÉn th·ªã help n√†y

‚öôÔ∏è Auto-sync: M·ªói 5 ph√∫t
üìç Repo: ${{ github.repository }}"
              
              send_message "$MSG"
              ;;
          esac
